name: Run E2E Tests for swift-sdk PR

on:
  pull_request:
    branches:
      - main
      - 2.0.0-alpha
  workflow_dispatch:

jobs:
  ui-tests:
    runs-on: macos-latest

    steps:
      - name: Checkout swift-sdk (this repo)
        uses: actions/checkout@v3

      - name: Get PR information
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          echo "PR Branch: ${{ github.head_ref }}"
          echo "PR Commit SHA: ${{ github.event.pull_request.head.sha }}"

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Verify Xcode version
        run: xcodebuild -version

      - name: Checkout examples-hub sample app
        uses: actions/checkout@v3
        with:
          repository: getpara/examples-hub
          token: ${{ secrets.GITHUB_TOKEN }}
          path: examples-hub
          ref: fix-ui-tests-env-vars

      - name: Update swift-sdk branch in project.pbxproj
        if: ${{ github.event_name == 'pull_request' }}
        working-directory: examples-hub/mobile/with-swift
        run: |
          PR_BRANCH="${{ github.head_ref }}"
          echo "Updating swift-sdk branch to $PR_BRANCH in project.pbxproj"
          sed -i '' '/repositoryURL = "https:\/\/github.com\/getpara\/swift-sdk"/,/kind = branch;/ s|\(branch = \)[^;]*;|\1'"$PR_BRANCH"';|' example.xcodeproj/project.pbxproj
          echo "Updated swift-sdk dependency:"
          grep -A 5 'XCRemoteSwiftPackageReference "swift-sdk"' example.xcodeproj/project.pbxproj

      - name: Resolve Package Dependencies
        working-directory: examples-hub/mobile/with-swift
        run: |
          xcodebuild -resolvePackageDependencies

      - name: Verify Environment Variables
        working-directory: examples-hub/mobile/with-swift
        env:
          PARA_API_KEY: ${{ secrets.PARA_API_KEY }}
          PARA_ENVIRONMENT: ${{ secrets.PARA_ENVIRONMENT }}
        run: |
          echo "✓ PARA_API_KEY configured (length: ${#PARA_API_KEY})"
          echo "✓ PARA_ENVIRONMENT: $PARA_ENVIRONMENT"

      - name: Run UI Tests on Simulator
        id: run-tests
        working-directory: examples-hub/mobile/with-swift
        env:
          PARA_API_KEY: ${{ secrets.PARA_API_KEY }}
          PARA_ENVIRONMENT: ${{ secrets.PARA_ENVIRONMENT }}
        run: |
          set -o pipefail
          xcodebuild \
            -scheme "Example" \
            -destination 'platform=iOS Simulator,OS=latest,name=iPhone 16 Pro' \
            -testPlan "Example" \
            -resultBundlePath TestResults \
            -parallel-testing-enabled NO \
            -only-testing:exampleUITests/ExampleUITests/test01EmailPasskeyCompleteFlow \
            -quiet \
            clean test \
            2>&1 | tee xcodebuild.log

      # Extract key failure information from logs
      - name: Show Test Failure Summary
        if: ${{ failure() }}
        working-directory: examples-hub/mobile/with-swift
        run: |
          echo "=== TEST FAILURE SUMMARY ==="
          echo "Last 50 lines of build log:"
          tail -50 xcodebuild.log || echo "No build log found"
          echo ""
          echo "Searching for test failures:"
          grep -i "test.*failed\|error\|assertion" xcodebuild.log | tail -10 || echo "No specific test failures found"
          echo "=========================="

      # Upload the raw xcodebuild.log
      - name: Upload Xcode build log
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-log
          path: examples-hub/mobile/with-swift/xcodebuild.log

      # Rename the test results directory only if needed
      - name: Rename test results
        if: ${{ always() }}
        working-directory: examples-hub/mobile/with-swift
        run: |
          if [ -d "TestResults" ]; then
            echo "Renaming TestResults -> TestResults.xcresult"
            mv TestResults TestResults.xcresult
          else
            echo "No 'TestResults' directory found (likely named TestResults.xcresult already)."
          fi

      # Upload the .xcresult bundle
      - name: Upload Xcode test results
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: xcode-test-results
          path: examples-hub/mobile/with-swift/TestResults.xcresult
