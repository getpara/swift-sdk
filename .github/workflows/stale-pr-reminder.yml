name: Stale PR Notification Workflow

on:
  schedule:
    - cron: '15 10 * * 1-5' # Weekdays, 10:15am

jobs:
  stale_prs:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repository:
          - capsule-org/user-management
          - capsule-org/web-sdk
          - getpara/swift-sdk
          - getpara/examples-hub
          - capsule-org/docs-mintlify
          - capsule-org/flutter-sdk
          - capsule-org/go-sdk
          - capsule-org/infrastructure
    steps:
      - name: Checkout Workflow Repository
        uses: actions/checkout@v3
        # This checks out the workflow repository, which should include your .github/user-map.json file.
      
      - name: Find PRs, Calculate Age, and Notify Stale Ones
        env:
          GH_TOKEN: ${{ secrets.CROSS_ORG_TOKEN }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          REPO_NAME: ${{ matrix.repository }}
          INACTIVITY_HOURS: 48
          MAP_FILE: .github/user-map.json
        run: |
          echo "üîÑ Checking Repository: $REPO_NAME"
          echo "‚è≥ Inactivity threshold: $INACTIVITY_HOURS hours"
          echo "üó∫Ô∏è Using map file: $MAP_FILE"

          # --- Fetch ALL open, non-draft PRs requiring review ---
          echo "üîç Fetching open PRs requiring review..."
          gh pr list \
            --repo "$REPO_NAME" \
            --state open \
            --search "-is:draft review:required" \
            --json number,title,url,author,reviewRequests,updatedAt \
            --limit 100 > all_prs.json

          PR_COUNT=$(jq length all_prs.json)
          echo "üìä Found $PR_COUNT open PRs requiring review."

          # Load mapping file content
          if [[ ! -f "$MAP_FILE" ]]; then
            echo "::error:: Mapping file '$MAP_FILE' not found!"
            exit 1
          fi
          USER_MAP=$(cat $MAP_FILE)

          # Function to send Slack DM
          send_slack_dm() {
            local user_id=$1
            local message=$2
            if [[ -z "$SLACK_BOT_TOKEN" ]]; then
              echo "::warning:: SLACK_BOT_TOKEN is not set. Cannot send DM to $user_id."
              echo "  Message was: $message"
              return 1
            fi
            if [[ -z "$user_id" || "$user_id" == "null" ]]; then
              echo "::warning:: Cannot send DM, Slack User ID is missing or null for message: $message"
              return 1
            fi

            echo "  üì§ Sending DM to Slack ID: $user_id"
            curl -s -f -S -X POST -H "Authorization: Bearer $SLACK_BOT_TOKEN" -H 'Content-type: application/json' \
              --data "{\"channel\":\"$user_id\",\"text\":\"$message\"}" \
              https://slack.com/api/chat.postMessage > /dev/null

            if [[ $? -ne 0 ]]; then
              echo "::error:: Failed to send Slack message to $user_id. Check token, permissions, and user ID."
              return 1
            fi
            return 0
          }

          NOW_SECONDS=$(date -u +%s)

          jq -c '.[]' all_prs.json | while read pr; do
            PR_NUM=$(echo $pr | jq -r .number)
            PR_TITLE=$(echo $pr | jq -r .title)
            PR_URL=$(echo $pr | jq -r .url)
            PR_AUTHOR_GH=$(echo $pr | jq -r .author.login)
            PR_UPDATED_AT=$(echo $pr | jq -r .updatedAt)

            echo ""
            echo "---"
            echo "üîé Processing PR #$PR_NUM: '$PR_TITLE'"
            echo "   URL: $PR_URL"
            echo "   Author: @$PR_AUTHOR_GH"
            echo "   Last Updated (UTC): $PR_UPDATED_AT"

            PR_UPDATED_SECONDS=$(date -u -d "$PR_UPDATED_AT" +%s)
            AGE_SECONDS=$(( NOW_SECONDS - PR_UPDATED_SECONDS ))
            AGE_HOURS=$(( AGE_SECONDS / 3600 ))
            AGE_DAYS=$(( AGE_HOURS / 24 ))

            echo "   Age: $AGE_HOURS hours (approx. $AGE_DAYS days)"

            if [[ "$AGE_HOURS" -ge "$INACTIVITY_HOURS" ]]; then
              echo "   üö¶ Status: STALE (Updated $AGE_HOURS hours ago, threshold is $INACTIVITY_HOURS hours)"
              PR_AUTHOR_SLACK=$(echo $USER_MAP | jq -r --arg GH_USER "$PR_AUTHOR_GH" '.[$GH_USER] // empty')
              if [[ -z "$PR_AUTHOR_SLACK" ]]; then
                 echo "   ::warning:: Slack ID not found for author '$PR_AUTHOR_GH'"
              fi

              REVIEWER_SLACK_IDS=()
              REVIEWER_GH_LOGINS=""
              HAS_REVIEWERS=false
              echo $pr | jq -c '.reviewRequests[] | .requestedReviewer | select(.__typename == "User" or .__typename == "Team")' | while read reviewer; do
                HAS_REVIEWERS=true
                REVIEWER_LOGIN=$(echo $reviewer | jq -r '.login // .name')
                SLACK_ID=$(echo $USER_MAP | jq -r --arg GH_USER "$REVIEWER_LOGIN" '.[$GH_USER] // empty')
                if [[ -n "$SLACK_ID" ]]; then
                  REVIEWER_SLACK_IDS+=("$SLACK_ID")
                  REVIEWER_GH_LOGINS="$REVIEWER_GH_LOGINS @$REVIEWER_LOGIN"
                else
                  echo "   ::warning:: Slack ID not found for reviewer '$REVIEWER_LOGIN'"
                  REVIEWER_GH_LOGINS="$REVIEWER_GH_LOGINS @$REVIEWER_LOGIN (Slack ID missing)"
                fi
              done
              REVIEWER_GH_LOGINS=$(echo "$REVIEWER_GH_LOGINS" | sed 's/^ //')
              if [[ "$HAS_REVIEWERS" = false ]]; then
                echo "   ‚ö†Ô∏è Status Update: PR #$PR_NUM is stale and requires review, but NO reviewers are currently requested via the 'Reviewers' field."
              fi
              echo "   Reviewers: $REVIEWER_GH_LOGINS"

              echo "   üîî Sending notifications..."
              if [[ -n "$PR_AUTHOR_SLACK" ]]; then
                if [[ "$HAS_REVIEWERS" = false ]]; then
                  AUTHOR_MSG="‚è≥ Reminder: Your PR <$PR_URL|$PR_TITLE> has had no activity for $AGE_HOURS hours and needs a reviewer assigned."
                else
                  AUTHOR_MSG="‚è≥ Reminder: Your PR <$PR_URL|$PR_TITLE> has had no activity for $AGE_HOURS hours and is awaiting review from: $REVIEWER_GH_LOGINS."
                fi
                send_slack_dm "$PR_AUTHOR_SLACK" "$AUTHOR_MSG"
              else
                echo "   Skipped DM to author @$PR_AUTHOR_GH (Slack ID missing)."
              fi

              if [[ "$HAS_REVIEWERS" = true ]]; then
                for SLACK_ID in "${REVIEWER_SLACK_IDS[@]}"; do
                  REVIEWER_MSG="‚è≥ Reminder: Please review PR <$PR_URL|$PR_TITLE> by @$PR_AUTHOR_GH. It has had no activity for $AGE_HOURS hours."
                  send_slack_dm "$SLACK_ID" "$REVIEWER_MSG"
                done
              else
                echo "   Skipped DM to reviewers (none assigned)."
              fi

            else
              echo "   ‚úÖ Status: RECENT (Updated $AGE_HOURS hours ago, threshold is $INACTIVITY_HOURS hours). Skipping notification."
            fi

            echo "--- Finished processing PR #$PR_NUM ---"
          done

          echo ""
          echo "‚úÖ Stale PR check complete."
